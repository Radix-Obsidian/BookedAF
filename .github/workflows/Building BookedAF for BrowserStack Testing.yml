#!/bin/bash

# BookedAF Build Script for BrowserStack Testing
echo "ğŸ—ï¸  Building BookedAF for BrowserStack Testing..."

# Clean previous builds
echo "ğŸ§¹ Cleaning previous builds..."
flutter clean
flutter pub get

# Check for Android SDK
if [ -z "$ANDROID_HOME" ]; then
    echo "âŒ Android SDK not found. Skipping Android build."
    echo "ğŸ’¡ To build APK: Install Android Studio and set ANDROID_HOME"
else
    echo "ğŸ“± Building Android APK..."
    flutter build apk --release
    
    if [ $? -eq 0 ]; then
        echo "âœ… Android APK built successfully!"
        echo "ğŸ“ Location: build/app/outputs/flutter-apk/app-release.apk"
    else
        echo "âŒ Android APK build failed"
    fi
fi

# Build iOS (if on macOS)
if [[ "$OSTYPE" == "darwin"* ]]; then
    echo "ğŸ Building iOS app..."
    flutter build ios --release --no-codesign
    
    if [ $? -eq 0 ]; then
        echo "âœ… iOS app built successfully!"
        echo "ğŸ“ Location: build/ios/iphoneos/Runner.app"
        
        # Create IPA if Xcode available
        if command -v xcodebuild &> /dev/null; then
            echo "ğŸ“¦ Creating IPA package..."
            cd ios
            
            # Archive the app
            xcodebuild -workspace Runner.xcworkspace \
                       -scheme Runner \
                       -configuration Release \
                       -destination generic/platform=iOS \
                       -archivePath build/Runner.xcarchive \
                       archive
            
            # Export IPA (requires ExportOptions.plist)
            if [ -f "ExportOptions.plist" ]; then
                xcodebuild -exportArchive \
                           -archivePath build/Runner.xcarchive \
                           -exportOptionsPlist ExportOptions.plist \
                           -exportPath build/
                
                if [ $? -eq 0 ]; then
                    echo "âœ… IPA created successfully!"
                    echo "ğŸ“ Location: ios/build/BookedAF.ipa"
                fi
            else
                echo "âš ï¸  ExportOptions.plist not found. Creating basic version..."
                cat > ExportOptions.plist << EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>development</string>
    <key>teamID</key>
    <string>YOUR_TEAM_ID</string>
</dict>
</plist>
EOF
                echo "ğŸ“ Created basic ExportOptions.plist - update with your Team ID"
            fi
            
            cd ..
        else
            echo "âš ï¸  Xcode not available for IPA creation"
        fi
    else
        echo "âŒ iOS build failed"
    fi
else
    echo "âš ï¸  iOS build only available on macOS"
fi

echo ""
echo "ğŸ¯ Build Summary:"
echo "=================="

# Check build outputs
if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
    apk_size=$(du -h build/app/outputs/flutter-apk/app-release.apk | cut -f1)
    echo "âœ… Android APK: $apk_size (build/app/outputs/flutter-apk/app-release.apk)"
else
    echo "âŒ Android APK: Not built"
fi

if [ -f "build/ios/iphoneos/Runner.app" ]; then
    echo "âœ… iOS App: Available (build/ios/iphoneos/Runner.app)"
else
    echo "âŒ iOS App: Not built"
fi

if [ -f "ios/build/BookedAF.ipa" ]; then
    ipa_size=$(du -h ios/build/BookedAF.ipa | cut -f1)
    echo "âœ… iOS IPA: $ipa_size (ios/build/BookedAF.ipa)"
else
    echo "âŒ iOS IPA: Not created"
fi

echo ""
echo "ğŸŒ Ready for BrowserStack Testing!"
echo "ğŸ“± Upload the built files to BrowserStack App Testing"
echo "ğŸ§ª Test Phase 1: Customer + Professional registration flows"
